# Fix Header Image in Worksheet PDF

Looking at your logs, I can see: `ğŸ“‹ Using header image: No (using stored or none)` - this means the header image isn't being passed to the PDF generator.

Let me provide the complete fix to make header images work globally:

---

## ğŸ”§ Implementation Steps

### **Step 1: Backend - Populate Header Image with Template**

#### Modify University Routes
```javascript
// backend/routes/university.js (or wherever your university routes are)

router.get('/', async (req, res) => {
  try {
    const universities = await University.find()
      .populate({
        path: 'defaultTemplateId',
        select: 'templateName sectionsOrder style level'
      })
      .select('name headerImageUrl defaultTemplateId analysisStatus')
      .lean();
    
    res.json(universities);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});
```

---

### **Step 2: Frontend - Store Header Image Globally**

#### Update GenerateWorksheet.jsx
```javascript
// frontend/src/pages/GenerateWorksheet.jsx

import { useState, useEffect } from 'react';
import { useGlobalConfig } from '../context/GlobalConfigContext';

function GenerateWorksheet() {
  const { universities } = useGlobalConfig();
  const [selectedUniversity, setSelectedUniversity] = useState(null);
  const [selectedTemplate, setSelectedTemplate] = useState(null);
  const [headerImageUrl, setHeaderImageUrl] = useState(null); // NEW
  
  const [formData, setFormData] = useState({
    topic: '',
    syllabus: '',
    difficulty: 'medium',
    subject: '',
    additionalInstructions: ''
  });

  // Handle university selection
  const handleUniversitySelect = (universityId) => {
    const university = universities.find(u => u._id === universityId);
    
    if (university) {
      console.log('ğŸ“ Selected University:', university);
      
      setSelectedUniversity(university);
      
      // Auto-set template
      if (university.defaultTemplateId) {
        setSelectedTemplate(university.defaultTemplateId);
        console.log('ğŸ“‹ Auto-selected Template:', university.defaultTemplateId.templateName);
      }
      
      // Auto-set header image URL
      if (university.headerImageUrl) {
        setHeaderImageUrl(university.headerImageUrl);
        console.log('ğŸ–¼ï¸ Auto-selected Header:', university.headerImageUrl);
      } else {
        setHeaderImageUrl(null);
        console.log('âš ï¸ No header image for this university');
      }
    }
  };

  // Generate worksheet
  const handleGenerate = async (e) => {
    e.preventDefault();
    
    const formDataToSend = new FormData();
    formDataToSend.append('topic', formData.topic);
    formDataToSend.append('syllabus', formData.syllabus);
    formDataToSend.append('difficulty', formData.difficulty);
    formDataToSend.append('subject', formData.subject);
    formDataToSend.append('templateId', selectedTemplate._id);
    formDataToSend.append('additionalInstructions', formData.additionalInstructions);
    
    // âœ… ADD HEADER IMAGE URL
    if (headerImageUrl) {
      formDataToSend.append('headerImageUrl', headerImageUrl);
      console.log('ğŸ–¼ï¸ Sending header image URL:', headerImageUrl);
    }
    
    // If user uploaded custom images
    if (uploadedImages.length > 0) {
      uploadedImages.forEach(file => {
        formDataToSend.append('images', file);
      });
    }

    try {
      const response = await fetch('/api/worksheets/generate?mode=sync', {
        method: 'POST',
        body: formDataToSend
      });
      
      const result = await response.json();
      console.log('âœ… Worksheet generated:', result);
      
      // Navigate to history or download
    } catch (error) {
      console.error('âŒ Generation failed:', error);
    }
  };

  return (
    <div>
      {/* University Dropdown */}
      <select onChange={(e) => handleUniversitySelect(e.target.value)}>
        <option value="">Select University</option>
        {universities.map(uni => (
          <option key={uni._id} value={uni._id}>
            {uni.name}
          </option>
        ))}
      </select>

      {/* Show selected template */}
      {selectedTemplate && (
        <div className="template-info">
          âœ… Template: {selectedTemplate.templateName}
        </div>
      )}

      {/* Show header image status */}
      {headerImageUrl && (
        <div className="header-info">
          ğŸ–¼ï¸ Header Image: {headerImageUrl.substring(0, 50)}...
        </div>
      )}

      {/* Rest of your form */}
      <form onSubmit={handleGenerate}>
        {/* ... existing form fields ... */}
        <button type="submit">Generate Worksheet</button>
      </form>
    </div>
  );
}
```

---

### **Step 3: Backend - Accept Header Image URL**

#### Update Worksheet Generation Route
```javascript
// backend/routes/worksheets.js (or similar)

router.post('/generate', upload.array('images', 10), async (req, res) => {
  try {
    const {
      topic,
      syllabus,
      difficulty,
      subject,
      templateId,
      additionalInstructions,
      headerImageUrl // âœ… NEW: Accept from frontend
    } = req.body;

    console.log('ğŸ“ Generate Worksheet Request:', {
      topic,
      syllabus,
      difficulty,
      subject,
      templateId,
      headerImageUrl, // âœ… Log it
      images: req.files?.length || 0
    });

    // Create worksheet document
    const worksheet = new Worksheet({
      userId: req.user._id,
      topic,
      syllabus,
      difficulty,
      subject,
      templateId,
      additionalInstructions,
      headerImageUrl, // âœ… Store in database
      status: 'processing'
    });

    await worksheet.save();

    // Generate content with AI
    const aiResponse = await generateWorksheetContent({
      topic,
      syllabus,
      difficulty,
      subject,
      templateId,
      additionalInstructions,
      images: req.files
    });

    // Update worksheet with AI response
    worksheet.content = aiResponse;
    worksheet.status = 'completed';
    await worksheet.save();

    res.status(201).json(worksheet);
  } catch (error) {
    console.error('âŒ Generation failed:', error);
    res.status(500).json({ error: error.message });
  }
});
```

---

### **Step 4: Backend - Add Header to PDF**

#### Update PDF Generation
```javascript
// backend/services/pdfGenerator.js (or wherever PDF generation happens)

const generatePDF = async (worksheet) => {
  const doc = new PDFDocument({
    size: 'A4',
    margins: { top: 50, bottom: 50, left: 50, right: 50 }
  });

  // âœ… ADD HEADER IMAGE
  if (worksheet.headerImageUrl) {
    try {
      console.log('ğŸ–¼ï¸ Adding header image:', worksheet.headerImageUrl);
      
      // Download the image from URL
      const imageResponse = await fetch(worksheet.headerImageUrl);
      const imageBuffer = await imageResponse.buffer();
      
      // Add to PDF
      doc.image(imageBuffer, 50, 30, {
        width: 500,
        align: 'center'
      });
      
      // Move cursor below header
      doc.moveDown(3);
      
    } catch (error) {
      console.error('âš ï¸ Failed to add header image:', error);
      // Continue without header if it fails
    }
  } else {
    console.log('ğŸ“‹ Using header image: No');
  }

  // Add title
  doc.fontSize(16)
     .font('Helvetica-Bold')
     .text(worksheet.topic, { align: 'center' });
  
  doc.moveDown();

  // Add content
  doc.fontSize(12)
     .font('Helvetica')
     .text(`Subject: ${worksheet.subject}`);
  
  // ... rest of your PDF generation logic ...

  return doc;
};
```

**OR** if you're using a different PDF library (like `jsPDF` or `pdfkit`):

```javascript
// Example with pdfkit
const PDFDocument = require('pdfkit');
const axios = require('axios');

router.post('/:id/generate-pdf', async (req, res) => {
  const worksheet = await Worksheet.findById(req.params.id);
  
  const doc = new PDFDocument();
  const chunks = [];
  
  doc.on('data', chunk => chunks.push(chunk));
  doc.on('end', () => {
    const pdfBuffer = Buffer.concat(chunks);
    res.contentType('application/pdf');
    res.send(pdfBuffer);
  });

  // âœ… ADD HEADER IMAGE
  if (worksheet.headerImageUrl) {
    try {
      const response = await axios.get(worksheet.headerImageUrl, {
        responseType: 'arraybuffer'
      });
      
      doc.image(response.data, 50, 30, { width: 500 });
      doc.moveDown(4);
      
      console.log('âœ… Header image added successfully');
    } catch (error) {
      console.error('âš ï¸ Header image failed:', error.message);
    }
  }

  // Rest of PDF content
  doc.fontSize(18).text(worksheet.topic, { align: 'center' });
  // ... more content ...

  doc.end();
});
```

---

### **Step 5: Update Worksheet Model**

```javascript
// backend/models/Worksheet.js

const worksheetSchema = new mongoose.Schema({
  userId: { type: ObjectId, ref: 'User', required: true },
  topic: String,
  syllabus: String,
  difficulty: String,
  subject: String,
  templateId: { type: ObjectId, ref: 'Template' },
  headerImageUrl: String, // âœ… ADD THIS FIELD
  content: Object,
  status: {
    type: String,
    enum: ['pending', 'processing', 'completed', 'failed'],
    default: 'pending'
  },
  createdAt: { type: Date, default: Date.now }
});
```

---

## ğŸ§ª Testing Checklist

1. **Admin uploads university with header image** âœ“
2. **User selects university from dropdown**
   - Check browser console: Should log `ğŸ–¼ï¸ Auto-selected Header: <URL>`
3. **User generates worksheet**
   - Check backend logs: Should show `headerImageUrl` in request
4. **PDF is generated**
   - Check logs: Should show `âœ… Header image added successfully`
   - Open PDF: Should see header image at top

---

## ğŸ› Debug Commands

Add these console logs to trace the flow:

```javascript
// Frontend: GenerateWorksheet.jsx
console.log('ğŸ“ Universities loaded:', universities);
console.log('ğŸ–¼ï¸ Header URL being sent:', headerImageUrl);

// Backend: worksheets route
console.log('ğŸ“¥ Received headerImageUrl:', req.body.headerImageUrl);

// Backend: PDF generator
console.log('ğŸ–¼ï¸ Worksheet has header:', worksheet.headerImageUrl);
```

---

This should fix your header image issue! The key is passing `headerImageUrl` from frontend â†’ backend â†’ PDF generator. Let me know if you need help with any specific part! ğŸš€