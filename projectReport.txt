Got it! Here's the **complete solution for JavaScript** (not TypeScript):

---

## **SOLUTION: Update Your Mongoose Schema**

### **ğŸ“ File: `models/Worksheet.js` (or wherever your schema is)**

```javascript
const mongoose = require('mongoose');

const worksheetSchema = new mongoose.Schema({
  title: String,
  topic: String,
  difficulty: String,
  syllabus: String,
  
  // User context
  university: String,
  course: String,
  semester: String,
  subject: String,
  
  // Main content structure
  content: {
    aim: String,
    problemStatement: String,
    dataset: String,
    imageAnalysis: String,
    
    // Questions array for multiple questions
    questions: [{
      number: Number,
      title: String,
      content: String,
      subParts: [String]
    }],
    
    objective: [String],
    
    // âœ… FIXED: Code as object instead of string
    code: {
      language: { type: String, default: 'plaintext' },
      source: String,
      explanation: String
    },
    
    output: String,
    learningOutcome: [String],
    additionalNotes: String
  },
  
  // Metadata
  variationSeed: Number,
  createdAt: { type: Date, default: Date.now },
  updatedAt: { type: Date, default: Date.now }
});

// Update timestamp on save
worksheetSchema.pre('save', function(next) {
  this.updatedAt = Date.now();
  next();
});

module.exports = mongoose.model('Worksheet', worksheetSchema);
```

---

## **ğŸ“ File: `routes/worksheets.js` (Your Route Handler)**

```javascript
import express from 'express';
import Worksheet from '../models/Worksheet.js';
import { generateWorksheet } from '../services/aiService.js'; // Your AI generation function

const router = express.Router();

router.post('/generate', async (req, res) => {
  try {
    const {
      topic,
      difficulty,
      syllabus,
      sections,
      userContext,
      userMemory,
      imageData // If user uploaded an image
    } = req.body;

    // Generate content using AI
    const prompt = buildPrompt(topic, difficulty, syllabus, sections, userContext, userMemory, imageData);
    const aiResponse = await generateWorksheet(prompt);
    
    // Parse AI response (assuming it returns JSON string)
    let generatedContent;
    try {
      // Remove markdown code fences if AI returns them
      const cleanedResponse = aiResponse
        .replace(/```json\n?/g, '')
        .replace(/```\n?/g, '')
        .trim();
      
      generatedContent = JSON.parse(cleanedResponse);
    } catch (parseError) {
      console.error('JSON parse error:', parseError);
      return res.status(500).json({ 
        error: 'AI returned invalid JSON',
        details: parseError.message,
        rawResponse: aiResponse.substring(0, 500) // First 500 chars for debugging
      });
    }

    // âœ… Validate code structure
    if (generatedContent.code) {
      // If AI returned string instead of object, convert it
      if (typeof generatedContent.code === 'string') {
        generatedContent.code = {
          language: 'plaintext',
          source: generatedContent.code,
          explanation: ''
        };
      }
      
      // Ensure all required fields exist
      if (!generatedContent.code.source) {
        generatedContent.code.source = generatedContent.code.source || '';
      }
      if (!generatedContent.code.language) {
        generatedContent.code.language = 'plaintext';
      }
      if (!generatedContent.code.explanation) {
        generatedContent.code.explanation = '';
      }
    }

    // Create worksheet document
    const worksheet = new Worksheet({
      title: `${topic} - ${difficulty}`,
      topic,
      difficulty,
      syllabus,
      university: userContext.university,
      course: userContext.course,
      semester: userContext.semester,
      subject: userContext.subject,
      content: generatedContent,
      variationSeed: Date.now()
    });

    // Save to database
    await worksheet.save();

    res.status(201).json({
      success: true,
      worksheet
    });

  } catch (error) {
    console.error('Generate worksheet error:', error);
    res.status(500).json({ 
      error: 'Failed to generate worksheet',
      details: error.message,
      stack: process.env.NODE_ENV === 'development' ? error.stack : undefined
    });
  }
});

// Helper function to build prompt
function buildPrompt(topic, difficulty, syllabus, sections, userContext, userMemory, imageData) {
  const variationSeed = Date.now();
  
  return `You are an ELITE ACADEMIC WORKSHEET GENERATOR for ${userContext.university}.

[... rest of your improved prompt ...]

${imageData ? `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ–¼ï¸ UPLOADED IMAGE DETECTED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
An image has been uploaded. Analyze it for:
â€¢ Text content (questions, problem statements, data)
â€¢ Diagrams, flowcharts, or visual elements
â€¢ Code snippets or formulas
â€¢ Tables or structured data

Integrate the image content appropriately into the worksheet structure.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
` : ''}

NOW GENERATE THE WORKSHEET WITH EXCELLENCE.`;
}

export default router;
```

---

## **ğŸ”§ Alternative: Keep Schema as String (Quick Fix)**

If you **don't want to change the schema**, modify the prompt to return code as a string:

### **Modified Prompt Section:**

```javascript
// In your prompt, replace the code section with:

"code": "LANGUAGE: python\\n\\n# Main code\\nprint('Hello')\\n\\n# EXPLANATION:\\n# This code demonstrates...",

"codeMetadata": {
  "language": "python",
  "hasExplanation": true
}
```

### **Then in your route, split it:**

```javascript
// After parsing AI response
if (generatedContent.code && typeof generatedContent.code === 'string') {
  // Code is already a string, MongoDB will accept it
  console.log('Code received as string - valid!');
}
```

---

## **ğŸ§ª Testing the Fix**

### **Test 1: Generate a Python worksheet**

```bash
curl -X POST http://localhost:3000/api/worksheets/generate \
  -H "Content-Type: application/json" \
  -d '{
    "topic": "Python Functions",
    "difficulty": "Beginner",
    "syllabus": "CS101",
    "sections": ["Aim", "Problem Statement", "Code", "Output"],
    "userContext": {
      "university": "XYZ University",
      "course": "Computer Science",
      "semester": "3",
      "subject": "Programming"
    }
  }'
```

### **Test 2: Check saved data**

```javascript
// In MongoDB shell or Compass
db.worksheets.findOne({}, { 'content.code': 1 })

// Should show:
// {
//   content: {
//     code: {
//       language: "python",
//       source: "def hello():\n    print('Hello')",
//       explanation: "<div>...</div>"
//     }
//   }
// }
```

---

## **ğŸ“‹ Complete Package Structure**

```
backend/
â”œâ”€â”€ models/
â”‚   â””â”€â”€ Worksheet.js          â† Updated schema
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ worksheets.js         â† Updated route with validation
â”œâ”€â”€ services/
â”‚   â””â”€â”€ aiService.js          â† Your AI integration (Gemini/OpenAI)
â””â”€â”€ utils/
    â””â”€â”€ promptBuilder.js      â† Extract prompt building logic (optional)
```

---

## **ğŸš¨ Common Issues & Fixes**

### **Issue 1: AI still returns string instead of object**

**Fix in route:**
```javascript
// Add this after parsing JSON
if (typeof generatedContent.code === 'string') {
  // Extract language from comment or default to plaintext
  const langMatch = generatedContent.code.match(/LANGUAGE:\s*(\w+)/i);
  const language = langMatch ? langMatch[1] : 'plaintext';
  
  generatedContent.code = {
    language: language,
    source: generatedContent.code.replace(/LANGUAGE:\s*\w+\n*/i, ''),
    explanation: ''
  };
}
```

### **Issue 2: Code object missing fields**

**Fix in route:**
```javascript
// Ensure code has all required fields
if (generatedContent.code && typeof generatedContent.code === 'object') {
  generatedContent.code = {
    language: generatedContent.code.language || 'plaintext',
    source: generatedContent.code.source || '',
    explanation: generatedContent.code.explanation || ''
  };
}
```

---

**That's it!** Update your schema, add the validation logic, and your error should be resolved. The AI will now correctly store code as an object with language, source, and explanation fields. ğŸ‰